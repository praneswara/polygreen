{% extends "admin/base.html" %}
{% block title %}Machines{% endblock %}

{% block content %}
<style>
  .card-title{
    font-size: 25px;
    color:#2373EC;
  }
  .small-download-btn .front {
        padding: 8px 20px;
        font-size: 0.9rem;
        display: block;
        letter-spacing: 1px;
        gap: 6px;
    }
    
    .small-download-btn img {
        width: 30px;
        height: 25px;
    }

.pushable {
  position: relative;
  background: transparent;
  padding: 0px;
  border: none;
  cursor: pointer;
  outline-offset: 4px;
  outline-color: #2373EC;
  transition: filter 250ms;
  -webkit-tap-highlight-color: rgba(0, 0, 0, 0);
}

#shadow {
  position: absolute;
  inset: 0;
  background: #86b6ff;
  border-radius: 8px;
  filter: blur(2px);
  transform: translateY(2px);
  transition: transform 600ms cubic-bezier(0.3, 0.7, 0.4, 1);
}

.edge {
  position: absolute;
  inset: 0;
  border-radius: 8px;
  background: linear-gradient(
    to right,
    #1f5ac1 0%,
    #2373ec 8%,
    #2373ec 92%,
    #1c4ea3 100%
  );
}

.front {
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 8px;
  background: #2373EC;
  padding: 14px 26px;
  color: white;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 1.5px;
  font-size: 1rem;
  transform: translateY(-4px);
  transition: transform 600ms cubic-bezier(0.3, 0.7, 0.4, 1);
}

.pushable:hover {
  filter: brightness(110%);
}

.pushable:hover .front {
  transform: translateY(-6px);
  transition: 250ms cubic-bezier(0.3, 0.7, 0.4, 1.5);
}

.pushable:hover .shadow {
  transform: translateY(4px);
}

.pushable:active .front {
  transform: translateY(-2px);
  transition: 34ms;
}

.pushable:active .shadow {
  transform: translateY(1px);
}

.pushable:focus:not(:focus-visible) {
  outline: none;
}
@media screen and (max-width: 600px) {

   .report-download{
    display: none;
  }
}

  #machineSearch{
 width:50% !important;
 height: 40px !important;
 border: solid black 2px;
 border-radius: 50px !important;
 
}
  .btn.full{
    background-color: #ff0000;
    border-radius: 20px;
    color:white;
    padding: 4px;
    font-size: 14px;
    cursor: not-allowed;
    pointer-events: none !important; 

  }
  .btn.available{
    background-color: #096709;
    border-radius: 20px;
    color:white;
    padding: 5px;
    font-size: 12px;
    cursor: not-allowed;
     pointer-events: none !important; 

  }
  .inner-card{
    display: flex;
    justify-content: space-between;
  }
  @media only screen and (max-width: 1000px) {
    .inner-card{
      align-items: center;
    }
  } 
  .detail{
    background-color:#2373EC ;
    color: white;
    font-weight: 500;
    border-radius: 10px;
  } 
  .detail:hover{
    background-color: #0350c3;
    color:white;
  }
  .addnew{
    background-color: rgb(35, 35, 218);
    color:white;
    font-size: 18px;
  }
  .addnew:hover{
    background-color: rgb(71, 71, 223);
    color:white;
  }
.search-add-download{
  display: flex;
  flex-direction: row;
  justify-content: center;
  align-items: center;
  gap: 30%;
  margin: 10px;
}


</style>

<h2 class="mb-4 text-center">Í∏∞Í≥Ñ</h2>
<div class="search-add-download">
  <input 
    type="text"
    id="machineSearch"
    class="form-control mb-3"
    placeholder="üîçÔ∏é  Í∏∞Í≥Ñ ID, Ïù¥Î¶Ñ, ÎèÑÏãú Í≤ÄÏÉâ..."
    onkeyup="filterMachines()"
>
<div>


<!-- <button class="btn btn-primary" ">Download Report</button> -->
<button class="pushable small-download-btn" onclick="downloadMachinesPDF()">
  <span id="shadow"></span>
  <span class="edge"></span>
  <span class="front">
     <img src="/static/download.png"  width="18" height="18">
  <span class="report-download">Download Report
  </span></span>
</button>
</div>
</div>


<div class="row">
  {% for machine in machines %}
  <div class="col-md-6">
      <div class="card mb-3 shadow machine-card border border-primary border-2"
     data-lat="{{ machine.lat }}"
     data-lng="{{ machine.lng }}"
     data-current="{{ machine.current_bottles }}"
     data-max="{{ machine.max_capacity }}"
     data-total="{{ machine.total_bottles }}"
     data-full="{{ machine.is_full }}"
     data-last="{{ machine.last_emptied }}"
     data-created="{{ machine.created_at }}">

      <div class="card-body">

        <div class="inner-card">
          <h5 class="card-title">
            {{ machine.name }} ({{ machine.machine_id }})
          </h5>

          <p class="btn  {% if machine.is_full %}full{% else %}available{% endif %} ">
            <strong>
              {% if machine.is_full %}Í∞ÄÎìùÌïú{% else %}ÏÇ¨Ïö© Í∞ÄÎä•{% endif %}
            </strong>
          </p>
        </div>

        <p>
          <img src="{{ url_for('static', filename='building.png')}}"
              width="30" height="30" class="m-1">
          <strong>{{ machine.city }}</strong>
        </p>

        <p>
          <a href="{{ url_for('admin_machine_detail', machine_id=machine.machine_id) }}"
             class="btn detail">ÏÑ∏Î∂Ä</a>
        </p>

        <!-- üî• Invisible data for PDF ‚Äî DOES NOT AFFECT UI -->
        <span class="m-data-id" style="display:none">{{ machine.machine_id }}</span>
        <span class="m-data-name" style="display:none">{{ machine.name }}</span>
        <span class="m-data-city" style="display:none">{{ machine.city }}</span>
        <span class="m-data-status" style="display:none">
          {% if machine.is_full %}FULL{% else %}AVAILABLE{% endif %}
        </span>
        <span class="m-data-current" style="display:none">{{ machine.current_bottles }}</span>
        <span class="m-data-max" style="display:none">{{ machine.max_capacity }}</span>
        <span class="m-data-total" style="display:none">{{ machine.total_bottles }}</span>
        <span class="m-data-lat" style="display:none">{{ machine.lat }}</span>
        <span class="m-data-lng" style="display:none">{{ machine.lng }}</span>
        <span class="m-data-created" style="display:none">{{ machine.created_at }}</span>
        <span class="m-data-emptied" style="display:none">{{ machine.last_emptied }}</span>

      </div>
    </div>

  </div>
  
  {% endfor %}
</div>
    <a href="{{ url_for('admin_add_machine') }}" class="btn mt-3 mb-3 addnew">
  <img src="{{ url_for('static', filename='plus..png')}}" width="25" height="25">
  ÏÉà Í∏∞Í≥Ñ Ï∂îÍ∞Ä
</a>


<script>
function filterMachines() {
    let input = document.getElementById("machineSearch").value.toLowerCase();
    let cards = document.querySelectorAll(".machine-card");

    cards.forEach(card => {
        let text = card.innerText.toLowerCase();
        card.style.display = text.includes(input) ? "" : "none";
    });
}

function downloadMachinesPDF() {

    const cards = document.querySelectorAll(".machine-card");
    let filtered = [];

    cards.forEach(card => {
        if (card.style.display !== "none") {

            filtered.push({
                machine_id: card.querySelector(".m-data-id").innerText.trim(),
                name: card.querySelector(".m-data-name").innerText.trim(),
                city: card.querySelector(".m-data-city").innerText.trim(),
                lat: card.dataset.lat,
                lng: card.dataset.lng,
                current_bottles: card.dataset.current,
                max_capacity: card.dataset.max,
                total_bottles: card.dataset.total,
                is_full: card.dataset.full,
                last_emptied: card.dataset.last,
                created_at: card.dataset.created
            });
        }
    });

    fetch("/admin/machines/report", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ data: filtered })
    })
    .then(res => res.blob())
    .then(blob => {
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "filtered_machines.pdf";
        a.click();
    });
}
</script>


{% endblock %}


