{% extends "admin/base.html" %}
{% block title %}Machines{% endblock %}

{% block content %}
<style>
  .card-title{
    font-size: 25px;
    color:#006d71;
  }
  .btn.full{
    background-color: #ff0000;
    border-radius: 20px;
    color:white;
    padding: 4px;
  }
  .btn.available{
    background-color: #096709;
    border-radius: 20px;
    color:white;
    padding: 5px;
    font-size: 12px;
  }
  .inner-card{
    display: flex;
    justify-content: space-between;
  }
  @media only screen and (max-width: 1000px) {
    .inner-card{
      align-items: center;
    }
  } 
  .detail{
    background-color:#006d71 ;
    color: white;
    font-weight: 500;
    border-radius: 10px;
  } 
  .detail:hover{
    background-color: #029297;
    color:white;
  }
  .addnew{
    background-color: rgb(35, 35, 218);
    color:white;
    font-size: 18px;
  }
  .addnew:hover{
    background-color: rgb(71, 71, 223);
    color:white;
  }
</style>

<h2 class="mb-4 text-center">Í∏∞Í≥Ñ</h2>

<input 
    type="text"
    id="machineSearch"
    class="form-control mb-3"
    placeholder="üîç Í∏∞Í≥Ñ ID, Ïù¥Î¶Ñ, ÎèÑÏãú Í≤ÄÏÉâ..."
    onkeyup="filterMachines()"
>

<div class="row">
  {% for machine in machines %}
  <div class="col-md-6">
      <div class="card mb-3 shadow machine-card"
     data-lat="{{ machine.lat }}"
     data-lng="{{ machine.lng }}"
     data-current="{{ machine.current_bottles }}"
     data-max="{{ machine.max_capacity }}"
     data-total="{{ machine.total_bottles }}"
     data-full="{{ machine.is_full }}"
     data-last="{{ machine.last_emptied }}"
     data-created="{{ machine.created_at }}">

      <div class="card-body">

        <div class="inner-card">
          <h5 class="card-title">
            {{ machine.name }} ({{ machine.machine_id }})
          </h5>

          <p class="btn {% if machine.is_full %}full{% else %}available{% endif %}">
            <strong>
              {% if machine.is_full %}Í∞ÄÎìùÌïú{% else %}ÏÇ¨Ïö© Í∞ÄÎä•{% endif %}
            </strong>
          </p>
        </div>

        <p>
          <img src="{{ url_for('static', filename='building.png')}}"
              width="30" height="30" class="m-1">
          <strong>{{ machine.city }}</strong>
        </p>

        <p>
          <a href="{{ url_for('admin_machine_detail', machine_id=machine.machine_id) }}"
             class="btn detail">ÏÑ∏Î∂Ä</a>
        </p>

        <!-- üî• Invisible data for PDF ‚Äî DOES NOT AFFECT UI -->
        <span class="m-data-id" style="display:none">{{ machine.machine_id }}</span>
        <span class="m-data-name" style="display:none">{{ machine.name }}</span>
        <span class="m-data-city" style="display:none">{{ machine.city }}</span>
        <span class="m-data-status" style="display:none">
          {% if machine.is_full %}FULL{% else %}AVAILABLE{% endif %}
        </span>
        <span class="m-data-current" style="display:none">{{ machine.current_bottles }}</span>
        <span class="m-data-max" style="display:none">{{ machine.max_capacity }}</span>
        <span class="m-data-total" style="display:none">{{ machine.total_bottles }}</span>
        <span class="m-data-lat" style="display:none">{{ machine.lat }}</span>
        <span class="m-data-lng" style="display:none">{{ machine.lng }}</span>
        <span class="m-data-created" style="display:none">{{ machine.created_at }}</span>
        <span class="m-data-emptied" style="display:none">{{ machine.last_emptied }}</span>

      </div>
    </div>
  </div>
  {% endfor %}
</div>

<a href="{{ url_for('admin_add_machine') }}" class="btn mt-3 mb-3 addnew">
  <img src="{{ url_for('static', filename='plus..png')}}" width="25" height="25">
  ÏÉà Í∏∞Í≥Ñ Ï∂îÍ∞Ä
</a>

<button class="btn btn-primary" onclick="downloadMachinesPDF()">üìÑ Download Machines PDF</button>

<script>
function filterMachines() {
    let input = document.getElementById("machineSearch").value.toLowerCase();
    let cards = document.querySelectorAll(".machine-card");

    cards.forEach(card => {
        let text = card.innerText.toLowerCase();
        card.style.display = text.includes(input) ? "" : "none";
    });
}

function downloadMachinesPDF() {

    const cards = document.querySelectorAll(".machine-card");
    let filtered = [];

    cards.forEach(card => {
        if (card.style.display !== "none") {

            filtered.push({
                machine_id: card.querySelector(".machine-id").innerText.trim(),
                name: card.querySelector(".machine-name").innerText.trim(),
                city: card.querySelector(".machine-city").innerText.trim(),
                lat: card.dataset.lat,
                lng: card.dataset.lng,
                current_bottles: card.dataset.current,
                max_capacity: card.dataset.max,
                total_bottles: card.dataset.total,
                is_full: card.dataset.full,
                last_emptied: card.dataset.last,
                created_at: card.dataset.created
            });
        }
    });

    fetch("/admin/machines/report", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ data: filtered })
    })
    .then(res => res.blob())
    .then(blob => {
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "filtered_machines.pdf";
        a.click();
    });
}


    fetch("/admin/machines/report", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ data: filtered })
    })
    .then(res => res.blob())
    .then(blob => {
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "filtered_machines.pdf";
        a.click();
    });
}
</script>

{% endblock %}

