{% extends "admin/base.html" %}
{% block title %}Machine Detail{% endblock %}

{% block content %}

<h2 class="text-center">ê¸°ê³„ ì„¸ë¶€ì‚¬í•­ - {{ machine.name }}</h2>

<!-- Machine Basic Info -->
<div class="card mb-3 mt-3 shadow">
  <div class="card-body">
    <div class="header-status">
      <h2 class="text">
        <img src="{{ url_for('static', filename='recycle.png')}}" width="35" height="35">
        {{ machine.name }}
      </h2>

      <p class="btn {% if machine.is_full %}full{% else %}available{% endif %}">
        <strong>{% if machine.is_full %}ê°€ë“í•œ{% else %}ì‚¬ìš© ê°€ëŠ¥{% endif %}</strong>
      </p>
    </div>

    <p>
      <img src="{{ url_for('static', filename='id.png')}}" width="30" height="30" class="m-1">
      <strong>{{ machine.machine_id }}</strong>
    </p>

    <p>
      <img src="{{ url_for('static', filename='building.png')}}" width="30" height="30" class="m-1">
      <strong>{{ machine.city }}</strong>
    </p>

    <p>
      <img src="{{ url_for('static', filename='Bottle.png')}}" width="30" height="30" class="m-1">
      <strong>{{ machine.total_bottles }} ìˆ˜ì§‘ëœ ë³‘</strong>
    </p>

    <p><strong> í˜„ì¬ ìš©ëŸ‰:</strong> {{ machine.current_bottles }} / {{ machine.max_capacity }}</p>

    <div class="progress mb-3" style="height: 25px; background-color:#ccc;">
      <div class="progress-bar {% if machine.current_bottles >= machine.max_capacity %}bg-danger{% else %}progress-meter{% endif %}"
           role="progressbar"
           style="width: {{ fill_percentage }}%;"
           aria-valuenow="{{ machine.current_bottles }}"
           aria-valuemin="0"
           aria-valuemax="{{ machine.max_capacity }}">
        {{ machine.current_bottles }} / {{ machine.max_capacity }}
      </div>
    </div>

    <div class="empty-last-update">
      <form action="{{ url_for('admin_empty_machine', machine_id=machine.machine_id) }}"
            method="POST"
            onsubmit="return confirm('ì´ ê¸°ê³„ë¥¼ ë¹„ìš°ì‹œê² ìŠµë‹ˆê¹Œ?');">
        <button type="submit" class="btn button mb-3">
          <img src="{{ url_for('static', filename='bin.png')}}" width="25" height="25">
          ë¹ˆ ê¸°ê³„
        </button>
      </form>

      <p class="btn last-emptied">
        <strong>ë§ˆì§€ë§‰ ë¹„ì›€: <span id="DateFormat"></span></strong>
      </p>
    </div>

  </div>
</div>


<!-- ========================= FILTERS ========================= -->
<h3 class="text-center fw-bold mb-4">ë§ˆì§€ë§‰ ê±°ë˜</h3>

{% if transactions %}

<div class="row mb-4">

  <!-- Search by User ID -->
  <div class="col-md-4 mb-2">
    <label class="fw-bold">ì‚¬ìš©ì ID ê²€ìƒ‰:</label>
    <input type="text" id="searchUserId" class="form-control"
           placeholder="ğŸ” ì‚¬ìš©ì ID..." onkeyup="filterTransactions()">
  </div>

  <!-- Date From -->
  <div class="col-md-4 mb-2">
    <label class="fw-bold">ë‚ ì§œ (From):</label>
    <input type="date" id="dateFrom" class="form-control" onchange="filterTransactions()">
  </div>

  <!-- Date To -->
  <div class="col-md-4 mb-2">
    <label class="fw-bold">ë‚ ì§œ (To):</label>
    <input type="date" id="dateTo" class="form-control" onchange="filterTransactions()">
  </div>

</div>


<!-- ========================= TRANSACTION TABLE ========================= -->
<div class="table-responsive-lg">
<table class="table custom-table" id="transactionsTable">
  <thead class="header-table">
    <tr>
      <th>ID</th>
      <th>ì‚¬ìš©ì ID</th>
      <th>ìœ í˜•</th>
      <th>ì „ì² ê¸°</th>
      <th>ë³‘</th>
      <th>ë¨¸ì‹  ID</th>
      <th>ë‚ ì§œ</th>
    </tr>
  </thead>

  <tbody>
    {% for t in transactions %}
    <tr>
      <td>{{ t.id }}</td>
      <td>{{ t.user_id }}</td>
      <td>{{ t.type }}</td>
      <td>{{ t.points }}</td>
      <td>{{ t.bottles }}</td>
      <td>{{ t.machine_id }}</td>
      <td class="trx-date">{{ t.created_at }}</td>
    </tr>
    {% endfor %}
  </tbody>
</table>

<a href="/admin/machines/{{ machine.machine_id }}/report" class="btn btn-primary">
  Download Machine PDF
</a>

</div>

{% else %}
<div class="d-flex justify-content-center align-items-center flex-column">
  <img src="{{ url_for('static', filename='Empty-amico.png')}}" width="500" height="500" class="empty">
  <p class="Empty">ì£„ì†¡í•©ë‹ˆë‹¤..! ì´ ê¸°ê³„ì— ëŒ€í•œ ê±°ë˜ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤..</p>
</div>
{% endif %}


<!-- ========================= STYLES ========================= -->
<style>
.progress-meter { background-color:#0cad95; color:black; font-weight:500;}
.header-table th { background-color:#006d71!important; color:white; }
table { border-radius: 15px!important; overflow:hidden!important; }
.custom-table th, .custom-table td { border:1px solid #006d71; text-align:center; }

table.custom-table tbody tr:nth-child(even) td { background-color:#b9ffec!important; font-weight:600; }
table.custom-table tbody tr:nth-child(odd) td { background-color:#ffffff!important; font-weight:600; }

.Empty { color:#006d71; font-size:35px; }
.button { background-color:#ffff00!important; color:black; font-weight:600; }
.button:hover { box-shadow:0 5px 5px rgba(0,0,0,0.6); }

.text { color:#006d71!important; }
.btn.full { background-color:#ff0000; border-radius:25px; color:white; }
.btn.available { background-color:#096709; border-radius:25px; color:white; }

.header-status { display:flex; justify-content:space-between; align-items:center; }
.btn.last-emptied { background-color:#7e7e7e; color:white; border-radius:5px; }

@media(max-width:700px){
  .empty { height:200px; width:200px; }
  .Empty { font-size:20px; }
}
</style>


<!-- ========================= JS LOGIC (UTC + FILTERS) ========================= -->
<script>

// Format last emptied date into UTC
document.addEventListener("DOMContentLoaded", function () {
    let lastEmptied = "{{ machine.last_emptied or 'N/A' }}";
    let box = document.getElementById("DateFormat");

    if (lastEmptied == "N/A") {
        box.textContent = "N/A";
    } else {
        let d = new Date(lastEmptied);
        box.textContent = d.toUTCString().replace("GMT", "").trim();
    }
});


// ğŸ”¥ Live filtering for search + date range
function filterTransactions() {
    let userSearch = document.getElementById("searchUserId").value.toLowerCase();
    let dateFrom = document.getElementById("dateFrom").value;
    let dateTo = document.getElementById("dateTo").value;

    let table = document.getElementById("transactionsTable");
    let trs = table.getElementsByTagName("tr");

    for (let i = 1; i < trs.length; i++) {
        let row = trs[i];
        let rowText = row.innerText.toLowerCase();
        let dateCell = row.querySelector(".trx-date");
        let trxDate = dateCell ? dateCell.innerText.split("T")[0] : "";

        let show = true;

        if (userSearch && !rowText.includes(userSearch)) show = false;
        if (dateFrom && trxDate < dateFrom) show = false;
        if (dateTo && trxDate > dateTo) show = false;

        row.style.display = show ? "" : "none";
    }
}

</script>

{% endblock %}
