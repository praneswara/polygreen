{% extends "admin/base.html" %}
{% block title %}Transactions{% endblock %}

{% block content %}

<h2 class="text-center mb-4">ì „ì²´ ê±°ë˜</h2>

<!-- ================= FILTERS ================= -->
<div class="row mb-4">

  <div class="col-md-3">
    <label class="fw-bold">ì‚¬ìš©ì ID</label>
    <input type="text" id="searchUser" class="form-control" onkeyup="filterData()">
  </div>

  <div class="col-md-3">
    <label class="fw-bold">ë¨¸ì‹  ID</label>
    <input type="text" id="searchMachine" class="form-control" onkeyup="filterData()">
  </div>

  <div class="col-md-2">
    <label class="fw-bold">ìœ í˜•</label>
    <select id="typeFilter" class="form-control" onchange="filterData()">
        <option value="">All</option>
        <option value="earn">Earn</option>
        <option value="redeem">Redeem</option>
    </select>
  </div>

  <div class="col-md-2">
    <label class="fw-bold">From</label>
    <input type="date" id="dateFrom" class="form-control" onchange="filterData()">
  </div>

  <div class="col-md-2">
    <label class="fw-bold">To</label>
    <input type="date" id="dateTo" class="form-control" onchange="filterData()">
  </div>
</div>

<!-- ==== DOWNLOAD BUTTON ==== -->
<button class="btn btn-primary mb-3" onclick="downloadFilteredPDF()">ğŸ“„ Download Filtered PDF</button>

<!-- ================= TABLE ================= -->
<div class="table-responsive-lg">
<table class="table custom-table" id="transactionsTable">
    <thead class="header-table">
        <tr>
            <th>ID</th>
            <th>ì‚¬ìš©ì ID</th>
            <th>ìœ í˜•</th>
            <th>ì „ì² ê¸°</th>
            <th>ë³‘</th>
            <th>ë¨¸ì‹  ID</th>
            <th>ë‚ ì§œ</th>
        </tr>
    </thead>

    <tbody>
        {% for t in transactions %}
        <tr>
            <td>{{ t.id }}</td>
            <td>{{ t.user_id }}</td>
            <td>{{ t.type }}</td>
            <td>{{ t.points }}</td>
            <td>{{ t.bottles }}</td>
            <td>{{ t.machine_id }}</td>
            <td class="trx-date">{{ t.created_at }}</td>
        </tr>
        {% endfor %}
    </tbody>
</table>
</div>


<!-- ============ FRONT-END FILTERING + EXPORT ============= -->
<script>
function filterData() {
    const user = document.getElementById("searchUser").value.toLowerCase();
    const machine = document.getElementById("searchMachine").value.toLowerCase();
    const type = document.getElementById("typeFilter").value.toLowerCase();
    const from = document.getElementById("dateFrom").value;
    const to = document.getElementById("dateTo").value;

    const rows = document.querySelectorAll("#transactionsTable tbody tr");

    rows.forEach(row => {
        const cols = row.innerText.toLowerCase();
        const date = row.querySelector(".trx-date").innerText.split("T")[0];

        let show = true;

        if (user && !cols.includes(user)) show = false;
        if (machine && !cols.includes(machine)) show = false;
        if (type && !cols.includes(type)) show = false;
        if (from && date < from) show = false;
        if (to && date > to) show = false;

        row.style.display = show ? "" : "none";
    });
}


// ğŸ”¥ Collect visible table rows and send to backend for PDF
function downloadFilteredPDF() {
    const rows = document.querySelectorAll("#transactionsTable tbody tr");
    let filtered = [];

    rows.forEach(r => {
        if (r.style.display !== "none") {
            const cells = r.querySelectorAll("td");
            filtered.push({
                id: cells[0].innerText,
                user_id: cells[1].innerText,
                type: cells[2].innerText,
                points: cells[3].innerText,
                bottles: cells[4].innerText,
                machine_id: cells[5].innerText,
                created_at: cells[6].innerText
            });
        }
    });

    fetch("/admin/transactions/report", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ data: filtered })
    })
    .then(response => response.blob())
    .then(blob => {
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "filtered_transactions.pdf";
        document.body.appendChild(a);
        a.click();
        a.remove();
    });
}
</script>

{% endblock %}
