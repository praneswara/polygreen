{% extends "admin/base.html" %}
{% block title %}Transactions{% endblock %}

{% block content %}

<style>

/* ===== TABLE THEME (Same as User Detail Page) ===== */

.table tbody tr.table-success td{
    background-color: #5da5d8 !important;
    color: rgb(0, 0, 0) !important;
    border: 2px solid black !important;
    text-align: center;
}

.table tbody tr.table-danger td{
    background-color: #ffffff !important;
    color: rgb(0, 0, 0) !important;
    border: 2px solid black !important;
    text-align: center;
}

.header-table th{
    background-color:#ffffff!important;
    color: black;
    border: 2px solid black !important;
    text-align: center;
}
  .small-download-btn .front {
        padding: 8px 20px;
        font-size: 0.9rem;
        display: block;
        letter-spacing: 1px;
        gap: 6px;
    }

    .small-download-btn img {
        width: 30px;
        height: 25px;
    }

.pushable {
  position: relative;
  background: transparent;
  padding: 0px;
  border: none;
  cursor: pointer;
  outline-offset: 4px;
  outline-color: #2373EC;
  transition: filter 250ms;
  -webkit-tap-highlight-color: rgba(0, 0, 0, 0);
}

.shadow {
  position: absolute;
  inset: 0;
  background: #86b6ff;
  border-radius: 8px;
  filter: blur(2px);
  transform: translateY(2px);
  transition: transform 600ms cubic-bezier(0.3, 0.7, 0.4, 1);
}

.edge {
  position: absolute;
  inset: 0;
  border-radius: 8px;
  background: linear-gradient(
    to right,
    #1f5ac1 0%,
    #2373ec 8%,
    #2373ec 92%,
    #1c4ea3 100%
  );
}

.front {
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 8px;
  background: #2373EC;
  padding: 14px 26px;
  color: white;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 1.5px;
  font-size: 1rem;
  transform: translateY(-4px);
  transition: transform 600ms cubic-bezier(0.3, 0.7, 0.4, 1);
}

.pushable:hover {
  filter: brightness(110%);
}

.pushable:hover .front {
  transform: translateY(-6px);
  transition: 250ms cubic-bezier(0.3, 0.7, 0.4, 1.5);
}

.pushable:hover .shadow {
  transform: translateY(4px);
}

.pushable:active .front {
  transform: translateY(-2px);
  transition: 34ms;
}

.pushable:active .shadow {
  transform: translateY(1px);
}

.pushable:focus:not(:focus-visible) {
  outline: none;
}

.custom-table td{
    border: 2px solid black !important;
    text-align: center;
}

.custom-table{
    border: 2px solid black !important;
}

/* Title style used everywhere */
.text {
    color:#ffffff !important;
    font-size: 25px;
}
.text-inner{
    color:black !important;
}

/* Filter label bold */
label.fw-bold {
    font-size: 16px;
}
.form-control{
  border: 2px solid black !important;
}
.form-control:hover{
   border: 2px solid #2373EC !important;
}
</style>


<h2 class="text text-center mb-4 text-inner">전체 거래</h2>


<!-- ================= FILTERS ================= -->
<div class="row mb-4">

  
    

  <div class="col-md-3 mb-2">
    <label class="fw-bold">머신 ID</label>
    <input type="text" id="searchMachine" class="form-control" onkeyup="filterData()">
  </div>

  <div class="col-md-2 mb-2">
    <label class="fw-bold">유형</label>
    <select id="typeFilter" class="form-control" onchange="filterData()">
        <option value="">All</option>
        <option value="earn">Earn</option>
        <option value="redeem">Redeem</option>
    </select>
  </div>

  <div class="col-md-2 mb-2">
    <label class="fw-bold">From</label>
    <input type="date" id="dateFrom" class="form-control" onchange="filterData()">
  </div>

  <div class="col-md-2 mb-2">
    <label class="fw-bold">To</label>
    <input type="date" id="dateTo" class="form-control" onchange="filterData()">
  </div>

</div>


<!-- ==== DOWNLOAD BUTTON ==== -->

    <button class="pushable small-download-btn mb-3"onclick="downloadFilteredPDF()">
  <span class="shadow"></span>
  <span class="edge"></span>
  <span class="front">
     <img src="/static/download.png"  width="18" height="18">
  <span class="report-download">Download Report
  </span></span>
</button>




<!-- ================= TABLE ================= -->
<div class="table-responsive-lg">
<table class="table custom-table" id="transactionsTable">
    <thead class="header-table">
        <tr>
            <th>ID</th>
            <th>사용자 ID</th>
            <th>유형</th>
            <th>전철기</th>
            <th>병</th>
            <th>머신 ID</th>
            <th>날짜</th>
        </tr>
    </thead>

    <tbody>
        {% for t in transactions %}
        <tr class="{% if t.type == 'earn' %}table-success{% else %}table-danger{% endif %}">
            <td>{{ t.id }}</td>
            <td>{{ t.user_id }}</td>
            <td>{{ t.type }}</td>
            <td>{{ t.points }}</td>
            <td>{{ t.bottles }}</td>
            <td>{{ t.machine_id }}</td>
            <td class="trx-date">{{ t.created_at }}</td>
        </tr>
        {% endfor %}
    </tbody>
</table>
</div>



<!-- ============ FILTER + PDF JS ============= -->
<script>

function filterData() {
    const user = document.getElementById("searchUser").value.toLowerCase();
    const machine = document.getElementById("searchMachine").value.toLowerCase();
    const type = document.getElementById("typeFilter").value.toLowerCase();
    const from = document.getElementById("dateFrom").value;
    const to = document.getElementById("dateTo").value;

    const rows = document.querySelectorAll("#transactionsTable tbody tr");

    rows.forEach(row => {
        const cols = row.innerText.toLowerCase();
        const date = row.querySelector(".trx-date").innerText.split("T")[0];

        let show = true;

        if (user && !cols.includes(user)) show = false;
        if (machine && !cols.includes(machine)) show = false;
        if (type && !cols.includes(type)) show = false;
        if (from && date < from) show = false;
        if (to && date > to) show = false;

        row.style.display = show ? "" : "none";
    });
}


// PDF
function downloadFilteredPDF() {
    const rows = document.querySelectorAll("#transactionsTable tbody tr");
    let filtered = [];

    rows.forEach(r => {
        if (r.style.display !== "none") {
            const cells = r.querySelectorAll("td");
            filtered.push({
                id: cells[0].innerText,
                user_id: cells[1].innerText,
                type: cells[2].innerText,
                points: cells[3].innerText,
                bottles: cells[4].innerText,
                machine_id: cells[5].innerText,
                created_at: cells[6].innerText
            });
        }
    });

    fetch("/admin/transactions/report", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ data: filtered })
    })
    .then(response => response.blob())
    .then(blob => {
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "filtered_transactions.pdf";
        a.click();
    });
}

</script>

{% endblock %}
